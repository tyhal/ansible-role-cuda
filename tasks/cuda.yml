# Only does checks of system
- name: check if nvidia drivers are working  # noqa 301
  register: gpu_working
  command: nvidia-smi
  ignore_errors: true

- include_tasks: "cuda/{{ ansible_os_family }}.yml"
  when: gpu_working is failed

- name: install cuda-drivers (needed for runtime)
  package:
    name: cuda-drivers
    state: present

- name: blacklist the nouveau driver module
  kernel_blacklist:
    name: nouveau
    state: present

- name: reboot to reload drivers
  reboot:
    post_reboot_delay: 30
  when: gpu_working is failed and inventory_hostname != "localhost"

- name: check if nvidia drivers are working
  command: nvidia-smi
  when: gpu_working is failed
